<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Migration Flow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="#">
  <style> body {margin: 0; font-family: sans-serif; width: 100vw; height: 100vh; overflow: hidden;}</style>

  <!-- Stylesheet -->
  <link rel="stylesheet" type="text/css" href="./css/main.css">

  <!-- DeckGl library - processing geospatial data-->
  <script src="https://unpkg.com/deck.gl@^8.4.0/dist.min.js"></script>
	<script src="https://unpkg.com/@deck.gl/carto@^8.4.0/dist.min.js"></script>

  <!-- Basemap loading -->
  <link href="https://libs.cartocdn.com/mapbox-gl/v1.13.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://libs.cartocdn.com/mapbox-gl/v1.13.0/mapbox-gl.js"></script>

  <!-- Document data manipulation-->
  <script src="https://d3js.org/d3.v4.min.js"></script>

  <!-- Chart plotting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <!-- JQuery -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

  <!-- Add icon library -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

  <!-- Materilize library - Mainly for the slider-->

</head>




<body>
  <div class="navContainer">
     <div class="logo-box">
        <a href="https://www.uzh.ch/en.html">
        <img src="https://www.geo.uzh.ch/microsite/giva/projects2021/Group9/Webpage/images/uzh_logo_e_pos.svg" height="68px" display="block"></img>
        </a>
     </div>
     <nav>
        <ul>
           <li className="introNav active"><a href="#introNav">Home</a></li>
           <li className="backgroundNav"><a href="#backgroundNav">background</a></li>
           <li className="mapNav"><a href="#mapNav">map</a></li>
           <li className="summaryNav"><a href="#summaryNav">summary</a></li>
           <li className="referencesNav"><a href="#referencesNav">references</a></li>
           <li className="authorsNav"><a href="#authorsNav">authors</a></li>
        </ul>
     </nav>
  </div>
  <div class="scrollableScreen" id="scrollableScreen">
  <div class="intro page" id="introNav">
     <div class="introWrapper">
        <img class="introImages"src="./images/mig_background.jpg" width="100%" height="100%" >
        <div class="e"><b>Remittance and Migration Flows</b></div>
        <div class="e"> 
           <span class="s">Global Patterns</span>
        </div>
     </div>
  </div>
  <div class="background page" id="backgroundNav">
     <div class= "text-box">
        <div class="text-title">Background</div>
        <div class= "text-section">
           <p style="text-align: justify"> <b>Why remittances matter:</b><br>
              The Sustainable Development Goals (SDG) are an urgent call
              for action to reduce all forms of inequality and deprivation 
              as well as to preserve the nature of our planet (UN, 2021). 
              These goals are to be achieved by 2030. Migration is a cross-cutting 
              issue and is relevant to all seventeen goals (Migration Data 
              Portal, no date). While it is not explicitly one of the goals, 
              it is crucial to understand migration patterns because of its 
              relationship to the goals above. This Web Page provides an 
              overview of migration and its aftereffect: Remittances.<br>
              <br>Remittances are household incomes from foreign countries 
              that result from the temporary or permanent movement of people 
              to those countries (IMF, 2009). In the past years the interest 
              in remittances increased and bridges between academic and 
              political spheres were created (Gubert, 2017). A specific United 
              Nation goal is to decrease transaction costs (SDG 10.c) of migrant 
              remittances, as this is one of the most important and mature steps 
              taken to increase incomes in developing countries (IOM, 2017). 
              Concrete examples in the Global Forum on Remittances, Investment 
              and Development (GFRID, 2017) have shown how migrant remittances 
              and diaspora investments were reducing poverty and hunger and 
              promoting access to health and education (UN, no date).<br>
           </p>
           <b>7 facts about remittances:</b>
           <br>
        </div>
        <img class="center-cropped" src="./images/Graphik_7Punkte_2.png" />
        <div class= "text-section">
           <p style="text-align: justify">In order to approach the reduction of inequalities – especially 
              the remittance costs, it is crucial to better understand the global 
              pattern and dynamics of migration and financial flows between countries. 
              According to the Global Knowledge Partnership on Migration and Development 
              (KNOMAD), which has the same objective, this knowledge can be used by 
              policy makers in sending and receiving countries (Gubert, 2017).
           </p>
        </div>
        <!-- 
        <iframe src="https://embed.ted.com/talks/lang/en/dilip_ratha_the_hidden_force_in_global_economics_sending_money_home"
          height=40% 
           width=60%
           allowfullscreen=true>    
        </iframe>
        -->
     </div>
  </div>
  <div class="mapPage page" id="mapNav">
     <div class="mapSwitch">
        <span class="mapSpan">Switch between the maps - </span>
        <div class="switch">
           <input type="radio" class="switch-input" name="view" value="migration" id="migration" checked>
           <label for="migration" class="switch-label switch-label-off">Migration</label>
           <input type="radio" class="switch-input" name="view" value="remittance" id="remittance">
           <label for="remittance" class="switch-label switch-label-on">Remittance</label>
           <span class="switch-selection"></span>
        </div>
     </div>
     <div class="migration selectt slide1">
        <div class="mapContainer">
           <div class="map" id="map"></div>
           <div class="arcslegend">
              <div class="text-legend">
                 <p style="font-size:15px;display:inline;text-align:justify"><b>Migration from 2010 to 2015</b>
                 <p style="font-size:12px;text-align:justify">Estimated Migration [Number of people]</p>
                 <div class="legend-break">
                    <span class="lg-area" style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(8,104,172);"></span>
                    <span> Legendeneintrag 1</span>
                 </div>
                 <div class="legend-break">
                    <span class="lg-area" style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(67,162,202);"></span>
                    <span> Legendeneintrag 2</span>
                 </div>
                 <div class="legend-break">
                    <span class="lg-area" style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(123,204,196);"></span>
                    <span> Legendeneintrag 3</span>
                 </div>
                 <div class="legend-break">
                    <span class="lg-area" style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(186,228,188);"></span>
                    <span> Legendeneintrag 4</span>
                 </div>
                 <div class="legend-break">
                    <span class="lg-area" style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(240,249,232)"></span>
                    <span> Legendeneintrag 5</span>
                 </div>
                 <p style="font-size:12px;text-align:justify">Average Anual Net Migration [number of migrants per 1000 inhabitants]</p>
                 <div class="legend-break">
                    <span class="lg-area" style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(8,104,172);"></span>
                    <span> Positive Net Migration</span>
                 </div>
                 <div class="legend-break">
                    <span class="lg-area" style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(123,204,196);"></span>
                    <span> Negative Net Migration</span>
                </div>
                <div class="legend-break">
                    <span class="lg-area" style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(186,228,188);"></span>
                    <span> Net Migration around 0</span>
                </div>
                <div class="legend-break">
                    <span class="lg-area" style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(240,249,232)"></span>
                    <span> <i> No data available</i> </span>
                </div>
              </div>
           </div>
        </div>
        <div class="optionBox">
           <fieldset class="layerSelection">
              <legend>Select a layer:</legend>
              <div class="wrapper">
                 <input type="radio" name="inout" id="option-1" value="e20_w0" onclick="layerChange(this.value)" checked>
                 <input type="radio" name="inout" id="option-2" value="i20_w0" onclick="layerChange(this.value)" >
                 <label for="option-1" class="option option-1">
                    <div class="dot"></div>
                    <span>Immigration</span>
                 </label>
                 <label for="option-2" class="option option-2">
                    <div class="second dot"></div>
                    <span>Emigration</span>
                 </label>
              </div>
           </fieldset>

           <div class="controlPanel">

             
             <div class="range-input1">
               <input type="range" min="1" max="7" value="1" step="1">
               <div class="value1">
                 <div></div>
              </div>
            </div>
            
            <script type="text/javascript">
              let rangeInput1 = document.querySelector(".range-input1 input");
              let rangeValue1 = document.querySelector(".range-input1 .value1 div");

              let start = parseFloat(rangeInput1.min);
              let end = parseFloat(rangeInput1.max);
              let step = parseFloat(rangeInput1.step);

              for(let i=start;i<=end;i+=step){
                rangeValue1.innerHTML += '<div>'+i+'</div>';
              }
              
              rangeInput1.addEventListener("input",function(){
                let top = (parseFloat(rangeInput1.value)-1)/step * -40;
                rangeValue1.style.marginTop = top+"px";
                console.log(rangeInput1.value);
                scale = rangeInput1.value;
                updateLayers(updateStartCountry, false);
              });
              </script>
            
            <div class="wrapper2">
              <div class="price-input">
                <div class="field">
                  <span>Min</span>
                  <input type="number" class="input-min" value="2500">
                </div>
                <div class="separator">-</div>
                <div class="field">
                  <span>Max</span>
                  <input type="number" class="input-max" value="7500">
                </div>
              </div>
              <div class="slider">
                <div class="progress"></div>
              </div>
              <div class="range-input">
                <input type="range" class="range-min" min="0" max="100000" value="2500" step="1">
                <input type="range" class="range-max" min="0" max="100000" value="7500" step="1">
              </div>
            </div>
          </div>

            <script type="text/javascript">
              const rangeInput = document.querySelectorAll(".range-input input"),
              priceInput = document.querySelectorAll(".price-input input"),
              range = document.querySelector(".slider .progress");
              let priceGap = 1000;
              console.log(priceInput[0].value)
              priceInput.forEach(input =>{
                input.addEventListener("input", e =>{
                  let minPrice = parseInt(priceInput[0].value),
                  maxPrice = parseInt(priceInput[1].value);
                      
                      if((maxPrice - minPrice >= priceGap) && maxPrice <= rangeInput[1].max){
                          if(e.target.className === "input-min"){
                              rangeInput[0].value = minPrice;
                              range.style.left = ((minPrice / rangeInput[0].max) * 100) + "%";
                          }else{
                              rangeInput[1].value = maxPrice;
                              range.style.right = 100 - (maxPrice / rangeInput[1].max) * 100 + "%";
                          }
                      }
                  });
              });
              rangeInput.forEach(input =>{
                  input.addEventListener("input", e =>{
                      let minVal = parseInt(rangeInput[0].value),
                      maxVal = parseInt(rangeInput[1].value);
                      if((maxVal - minVal) < priceGap){
                          if(e.target.className === "range-min"){
                              rangeInput[0].value = maxVal - priceGap
                          }else{
                              rangeInput[1].value = minVal + priceGap;
                          }
                      }else{
                          priceInput[0].value = minVal;
                          priceInput[1].value = maxVal;
                          range.style.left = ((minVal / rangeInput[0].max) * 100) + "%";
                          range.style.right = 100 - (maxVal / rangeInput[1].max) * 100 + "%";
                      }

                      updateLayers(updateStartCountry, false);
                  });
              });
            </script>
            


           <div class="chartWrapper chartSelector">
              <button type="button" class="expandChart btn"><i class="fa-solid fa-expand"></i></button>
              <canvas id="myChart" height="250"></canvas>
           </div>
        </div>
     </div>
     <div class="remittance selectt slide2">
        <div class="mapContainer">
           <div class="map" id="map_symbols"></div>
           <div class="symbolslegend">
              <div class="text-legend">
                 <p style="font-size:15px;display:inline;text-align:justify"><b>Worldwide Remittance Flows between 2017 and 2020</b>
                 <p style="font-size:12px;text-align:justify">Amount of Remittances received and sent [Mio US$]</p>
                 <div class="legend-break">
                    <span style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgba(255, 187, 67, 150);"></span>
                    <span> Remittance received</span>
                 </div>
                 <div class="legend-break">
                    <span style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgba(109, 160, 111, 100);"></span>
                    <span> Remittances sent</span>
                 </div>
              </div>
           </div>
        </div>
        <div class="optionBox">
           <fieldset class="layerSelection">
              <legend>Select a year:</legend>

              <div class="wrapper">
                <input type="radio" name="layerYear" id="option-4" value="r17" onclick="layerChangeR(this.value)" checked>
                <input type="radio" name="layerYear" id="option-5" value="r18" onclick="layerChangeR(this.value)" >
                <input type="radio" name="layerYear" id="option-6" value="r19" onclick="layerChangeR(this.value)" >
                <input type="radio" name="layerYear" id="option-7" value="r20" onclick="layerChangeR(this.value)" >
                <label for="option-4" class="option option-4">
                   <div class="dot"></div>
                   <span>2017</span>
                </label>
                <label for="option-5" class="option option-5">
                   <div class="dot"></div>
                   <span>2018</span> 
                </label>
                <label for="option-6" class="option option-6">
                  <div class="dot"></div>
                  <span>2019</span>
               </label>
               <label for="option-7" class="option option-7">
                  <div class="dot"></div>
                  <span>2020</span> 
               </label>
             </div>
           </fieldset>
        </div>
     </div>
     <script type="text/javascript">
        $(".remittance").hide();
        $(document).ready(function() {
            $('input[type="radio"]').click(function() {
                var inputValue = $(this).attr("value");
                var targetBox = $("." + inputValue);
                if(inputValue === "migration" || inputValue ==="remittance"){  
                  showElement = $(targetBox);
                  $(".selectt").not(targetBox).hide();
                  showElement.show();
                }
            });
        });
        
        $(document).ready(function() {
          $('.expandChart').click(function() {
            var chartWrapper = $('.chartSelector');
            if (chartWrapper.hasClass('chartWrapper')) {
              $('.chartWrapper').removeClass("chartWrapper").addClass("chartBigWrapper");
              createPlot(countryNumbers, 15);
            } else {
              $('.chartBigWrapper').removeClass("chartBigWrapper").addClass("chartWrapper")
              createPlot(countryNumbers, 5);
            }
        
          })
        })
     </script>
     </div>
     <div class="summary page" id="summaryNav">
        <div class= "text-box">
           <div class="text-title">Summary</div>
           <div class= "text-section">
              <p> Hier kommt der Text hin </p>
           </div>
        </div>
     </div>
     <div class="references page" id="referencesNav">
        <div class= "text-box">
           <div class="text-title">References</div>
           <div class= "text-section">
              <p> International Monetary Fund (IMF) (2009) <i>International Transactions in Remittances: Guide for Compilers and Users.</i> doi: 10.1111/j.1468-2435.2009.00540.x.<br>
                 <br>Gubert, F. (2017) <i>Migration, Remittances and Development: Insights from the Migration and Development Conference, Revue d’Economie du Developpement,</i> 25(3–4), pp. 29–44. doi: 10.3917/edd.313.0029.<br>
                 <br>IOM (2017) <i>International dialogue on migration: Follow-up and review of migration in the sustainable development goals,</i> in.<br>
                 <br>Portal, M. D. (no date) <i>Migration data and the Sustainable Development Goals (SDGs).</i> Available at: https://www.migrationdataportal.org/sdgs?node=0.<br>
                 <br>UN (2019) <i>Remittances matter: 8 facts you don’t know about the money migrants send back home.</i> Available at: https://www.un.org/development/desa/en/news/population/remittances-matter.html.<br>
                 <br>UN (2021) <i>The Sustainable Development Goals Report 2021.</i><br>
                 <br>UN (no date) <i>Putting a spotlight on the role of migrant remittances in achieving the SDGs.</i> Available at: https://www.un.org/hi/desa/putting-spotlight-role-migrant-remittances-achieving-sdgs.
              </p>
           </div>
        </div>
     </div>
     <div class="authors page" id="authorsNav">
        <div class="profile-card">
           <div class="img">
              <img src="./images/annina_stroke_2_cropped.png" ></img>
           </div>
           <div class="caption">
              <h3>Annina Ardüser</h3>
              <p>Master Student GIS</p>
           </div>
           <div class="social-links">
           </div>
        </div>
        <div class="profile-card">
           <div class="img">
              <img src="./images/team-2.jpg"></img>
           </div>
           <div class="caption">
              <h3>Fiona Federer</h3>
              <p>Master Student GIS</p>
              <div class="social-links">
              </div>
           </div>
        </div>
        <div class="profile-card">
           <div class="img">
              <img src="./images/annina_portrait.png"></img>
           </div>
           <div class="caption">
              <h3>Silvan Caduff</h3>
              <p>Master Student GIS</p>
              <div class="social-links">
              </div>
           </div>
        </div>
     </div>
  </div>
</body>




<script language="JavaScript">  
    const pages = document.querySelectorAll('.page');
    const navLi = document.querySelectorAll('nav li');
    const scr = document.getElementById('scrollableScreen');
    
    scr.onscroll = () => {
    var current = "";
    pages.forEach((page) => {
        const pageTop = page.offsetTop;
        if(scr.scrollTop >= (pageTop - 400)) {
        current = page.getAttribute('id');
        }
    });
    
    navLi.forEach((li) => {
        li.classList.remove('active');
        
        if(li.classList.contains(current)){
        li.classList.add('active');
        }
    });
    };

    // Get components from the deckgl library
    const {DeckGL, GeoJsonLayer, ArcLayer, ScatterplotLayer, IconLayer} = deck;


    // Create deck instance symbols
    const deckgl_symbols = new DeckGL({
        mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
        container: 'map_symbols',
        initialViewState: {
          longitude: 6,
          latitude: 50,
          zoom: 3,
          maxZoom: 15,
          pitch: 30,
          bearing: 0
        },
        controller: true,
        layers: []
      });

    // colour scheme
    //teal: #d1eeea,#a8dbd9,#85c4c9,#68abb8,#4f90a6,#3b738f,#2a5674

    const POLYGON_COLORS = {
      COLOR_1: [8,81,156, 50], //blue
      COLOR_2: [255,255,255, 50], //grey
      COLOR_3: [0,109,44, 50], //green
      COLOR_nodata: [249,237,237,30],
    };
  
    const ICON_MAPPING_OUT = {
      marker: {x: 1242, y: 0, width: 1242, height: 2479, anchorX: 0, anchorY: 1239.5, mask: true}
    }

    const ICON_MAPPING_IN = {
      marker: {x: 0, y: 0, width: 1242, height: 2479, anchorX: 1300, anchorY: 1239.5, mask: true}
    }

    var data_sorted = [];
    var iconLayer_in = '';
    var iconLayer_out = '';
    var in_out = 'r';
    var year_r = '17';
    var colorD3 = [];

    layerChangeR("r17");

    function layerChangeR(name) {
      fetch('https://raw.githubusercontent.com/sicadu/geovis/main/reactless/data/'+name+'.json')
      .then(res => res.json())
      .then(d => updateLayersR(d));
    }
    
    function updateLayersR(data_r) {

      const iconLayer_out = new IconLayer({
          id:'icon_out',
          data: data_r,
          pickable: true,
          iconAtlas: 'https://raw.githubusercontent.com/sicadu/geovis/main/reactless/images/Remi_in_out.png',
          iconMapping: ICON_MAPPING_OUT,
          getIcon: d => 'marker',
          getPosition: d => [d.X, d.Y],
          getSize: d => (Math.sqrt(d.REMI_O))/2,
          //sizeScale: 10,
          // Option A: if funktion, geht nicht egal ob ''/""/- und auch egal ob (REMI_O !== undefined return 10 oder REMI_O >=0 return 10)
          //sizeMinPixels: d => {
            //if (d.REMI_O == "undefined") {
              //return 0;
            //} 
            //else {
              //return 10;
            //}},

          //Option B: definiere minSize 
          sizeMinPixels: 10,

          //Option C: definiere nichts: alle herausgelöschten Remis werden nicht angezeigt

          //Option D: lösche ganze Geometrien raus, wenn nicht komplett > am wenigsten
          getColor: d => [109, 160, 111, 150]
        });
        
        const iconLayer_in = new IconLayer({
          id: 'icon_in',
          data: data_r,
          pickable: true,
          iconAtlas: 'https://raw.githubusercontent.com/sicadu/geovis/main/reactless/images/Remi_in_out.png',
          iconMapping: ICON_MAPPING_IN,
          getIcon: d => 'marker',
          getPosition: d => [d.X, d.Y],
          getSize: d => (Math.sqrt(d.REMI_I))/2,
          //sizeScale: 0,
          sizeMinPixels: 10,
          /*sizeMinPixels: d => {
            if (d.REMI_I == "undefined" ) {
              return 0;
            }
            else {
              return 10;
            }},*/
          getColor: d => [255, 187, 67, 150],
          pickable: true
        });

        // evtl remittance costs hinzunehmen / remittance cost charts
        deckgl_symbols.setProps({
          layers: [iconLayer_in, iconLayer_out, backgroundMap_symbols],
          getTooltip: ({object}) => object && {
            html: `
            <p><b> Country: </b>${object.COUNTRY}</p>
            <p><b> Remittances received: </b>${object.REMI_I} Mio. | ${(object.REMI_I*100000000/object.GDP).toFixed(2)}% of GDP</p>
            <p><b> Remittances sent: </b>${object.REMI_O} Mio. | ${(object.REMI_O*100000000/object.GDP).toFixed(2)}% of GDP</p>
            `,
            style: {
              color: '#000000',
              fontSize: '0.2em',
              backgroundColor: '#f5f5f5',
              opacity: 0.85
            }
          }});
    }

    // create choropleth map  
    const choroplethMap = new GeoJsonLayer({
      data: 'https://raw.githubusercontent.com/sicadu/geovis/main/reactless/data/netMig_2010_2015_2020.json',
      pickable: true,
      stroked: true,
      filled: true,
      wireframe: true,
      getPolygon: d => d.features.geometry.coordinates,
      getLineColor: [150,150,150],
      getLineWidth: 1,
      lineWidthMinPixels: 1,
      getFillColor: a => {
        if (a.properties.F2010_2015 == null) {
          return POLYGON_COLORS.COLOR_nodata
        }
        else if (a.properties.F2010_2015 < -1.0) {
          return POLYGON_COLORS.COLOR_1; //negative Net Migration = blue
        } 
        else if (a.properties.F2010_2015 < 1.0) {
          return POLYGON_COLORS.COLOR_2; //~0 = grey
        } 
        else if (a.properties.F2010_2015 < 55.0) {
          return POLYGON_COLORS.COLOR_3; //positive Net Migation = green
        /*} 
        else if (a.properties.F2010_2015 < 18.0) {
          return POLYGON_COLORS.COLOR_4;
        } 
        else if (a.properties.F2010_2015 < 55.0) {
          return POLYGON_COLORS.COLOR_5;*/
        };
      },
    });


    const backgroundMap_symbols = new GeoJsonLayer({
      data: 'https://raw.githubusercontent.com/sicadu/geovis/main/reactless/data/WorldCountries.geojson',
      pickable: true,
      stroked: true,
      filled: false,
      wireframe: true,
      getPolygon: d => d.features.geometry.coordinates,
      getLineColor: [150,150,150],
      getLineWidth: 0.3,
      lineWidthMinPixels: 1,
    });



    // Create deck instance arcs
    const deckgl = new DeckGL({
        mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
        container: 'map',
        initialViewState: {
          longitude: 6,
          latitude: 50,
          zoom: 3,
          maxZoom: 15,
          pitch: 30,
          bearing: 0
        },
        controller: true,
        layers: []
      });



    
    // Define Arc colors -- Color with colorBrewer sequential 5 Colors 
    const inFlowColors = [ 
      [237,248,251],
      [178,226,226],
      [102,194,164],
      [44,162,95],
      [0,109,44]
    ];


    [237,248,251],[178,226,226],[102,194,164],[44,162,95],[0,109,44]
    const outFlowColors = [
      [240,249,232],
      [186,228,188],
      [123,204,196],
      [67,162,202],
      [8,104,172],
    ];

    

    var dataSorted = [];
    var countyLayer = '' ;
    var arcLayer = '';
    var countryNumbers;
    var migration = 'e20_w0'
    var startCountry = 'GERMANY';
    var breaks_e = [32, 177, 866, 6156];
    var breaks_i = [25, 136, 693, 5097];
    var scale = 1;
    var arc_data;
    var updateStartCountry;

    const widthScale = () => scale

    layerChange("e20_w0");

    function layerChange(layerName) {
      migration = layerName;
      fetch('https://raw.githubusercontent.com/sicadu/geovis/main/reactless/data/'+layerName+'.json')
      .then(res => res.json())
      .then(data => {
        arc_data = data
        dataSorted = keysrt(data.features, ['properties','COUNTRY']);
        updateLayers(
          dataSorted.find(f => f.properties.COUNTRY === startCountry), true
        );
        countyLayer = new GeoJsonLayer({
          id: 'geojson',
          data,
          stroked: true,
          getFillColor: [0,0,0,0],
          getLineColor: [240,249,232],
          onClick: info => updateLayers(info.object, true),
          pickable: true
        });
      }); 
      if (layerName === 'e20_w0'){
        updateLegend(inFlowColors);
      } else {
        updateLegend(outFlowColors);
      }
    }

    function updateLayers(dataFeature, truePlot) {
        selectedFeature = dataSorted.find(f => f.properties.COUNTRY === dataFeature.properties.COUNTRY);
        updateStartCountry = dataFeature; 
        startCountry = dataFeature.properties.COUNTRY;

        const flows = selectedFeature.properties.flows;
        const centroid = selectedFeature.geometry.centroid;


        const arcs = Object.keys(flows).map(toId => {
          const f = dataSorted[toId];
          return {
            source: centroid,
            target: f.geometry.centroid,
            value: flows[toId]
          };
        });

        countryNumbers = Object.keys(flows).map(toId => {
          const r = dataSorted[toId];
          return {
            country: r.properties.COUNTRY,
            migration: flows[toId]
          };
        });

        colorList(arcs);
        if(truePlot){createPlot(countryNumbers, 5);}

        arcLayer = new ArcLayer({
          id: 'arc',
          data: arcs,
          getSourcePosition: d => d.source,
          getTargetPosition: d => d.target,
          getSourceColor: d => checkBreaksForColor(d.value),
          getTargetColor: d => checkBreaksForColor(d.value),
          widthMinPixels: 1, /* Breite von Linien*/
          getWidth: d => {checkBreaksForWidth(d.value)},
          getHeight: 0.5,
          widthScale: scale,
          updateTriggers: {
            widthScale: [scale]
          },
          getFilterValue: d => d.value,
          filterRange: [parseInt(priceInput[0].value), parseInt(priceInput[1].value)],
          extensions: [new deck.DataFilterExtension({filterSize: 1})]
        });

        deckgl.setProps({
          layers: [choroplethMap, countyLayer, arcLayer]
        });
    }

    function updateScaleWidth() {
      arcLayer.setProps({ 
        widthScale,
        updateTriggers: {
          widthScale: scale
        }
      });
    };

    function keysrt(arr, keyArr, reverse) {
          var sortOrder = 1;
          if(reverse)sortOrder = -1;
          return arr.sort(function(a, b) {
              var x=a,y=b;
              for (var i=0; i < keyArr.length; i++) {
                x = x[keyArr[i]];
                y = y[keyArr[i]];
              }
              return sortOrder * ((x < y) ? -1 : ((x > y) ? 1 : 0));
          });
      }

    var myChart;


    function createPlot(data, n){
      if (myChart){
        myChart.destroy();
      }

      var topCountries = getTopN(data, 'migration', n);
      var migrationValues = [];
      var countryKey = [];

      for (let i =0; i<n ;i++) {
        migrationValues.push(topCountries[i]['migration']);
        countryKey.push(topCountries[i]['country']);
      } 

      Chart.register(ChartDataLabels)

      const config = {
        type: 'bar',
        data: {
          labels: countryKey,
          datasets: [
            {
              backgroundColor: colorD3,
              data: migrationValues,
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'start',

              }
            }
          ]
        },
        options: {
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            title: {display: true, 
              text: 'Top Migration',
              font: {
                size: 15,
              }},
            legend: {display: false},
            tooltips: {enabled: false}
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        },
        plugins: [ChartDataLabels]
      };

      myChart = new Chart(
        document.getElementById('myChart'),
        config
      );
    }

    function getTopN(arr, prop, n) {
      // clone before sorting, to preserve the original array
      var clone = arr.slice(0); 

      // sort descending
      clone.sort(function(x, y) {
          if (x[prop] == y[prop]) return 0;
          else if (parseInt(x[prop]) < parseInt(y[prop])) return 1;
          else return -1;
      });

      return clone.slice(0, n || 1);
    }

    function colorList(arr) {
      colorD3 = [];
      for (var i = 0; i < arr.length; i++) {
        color_rgb = checkBreaksForColor(arr[i]);
        color_hex = rgbToHex(color_rgb[0], color_rgb[1], color_rgb[2]);
        colorD3.push(color_hex);
      }
    }

    // helper function for colorList
    function componentToHex(c) {
      var hex = c.toString(16);
      return hex.length == 1 ? "0" + hex : hex;
    }

    function rgbToHex(r, g, b) {
      return "#" + componentToHex(r) + componentToHex(g) + componentToHex(b);
    }
  
    window.addEventListener("scroll", () => {
      if (window.pageYOffset > 100) {
        toTop.classList.add("active");
      } else {
        toTop.classList.remove("active");
      }
    })

    function checkBreaksForColor(color){
      if (migration == 'e20_w0') {
        if (color < breaks_e[0]){
          return inFlowColors[0]
        } else if (color < breaks_e[1]){
          return inFlowColors[1]
        } else if (color < breaks_e[2]){
          return inFlowColors[2]
        } else if (color < breaks_e[3]){
          return inFlowColors[3]
        } else {
          return inFlowColors[4]
        }
      } else {
        if (color < breaks_i[0]){
          return outFlowColors[0]
        } else if (color < breaks_i[1]){
          return outFlowColors[1]
        } else if (color < breaks_i[2]){
          return outFlowColors[2]
        } else if (color < breaks_i[3]){
          return outFlowColors[3]
        } else {
          return outFlowColors[4]
        }

      }
    }

    function checkBreaksForWidth(color){
      if (color < breaks_e[0]){
        return 1
      } else if (color < breaks_e[1]){
        return 4
      } else if (color < breaks_e[2]){
        return 7
      } else if (color < breaks_e[3]){
        return 10
      } else {
        return 13
      }
    }
  
  function updateLegend(sign){
    legend_colors = $('.lg-area');
    for (let i = 0; i < legend_colors.length; i++){
        legend_colors[i].style.backgroundColor = "rgb(" + sign[4-i][0] + "," + sign[4-i][1] + "," + sign[4-i][2] + ")";
    }
  }
  
  
  </script>