<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Migration Flow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="shortcut icon" href="#">
  <style> body {margin: 0; font-family: sans-serif; width: 100vw; height: 100vh; overflow: hidden;}</style>

  <!-- Stylesheet -->
  <link rel="stylesheet" type="text/css" href="./css/main.css">

  <!-- DeckGl library - processing geospatial data-->
  <script src="https://unpkg.com/deck.gl@^8.4.0/dist.min.js"></script>
	<script src="https://unpkg.com/@deck.gl/carto@^8.4.0/dist.min.js"></script>

  <!-- Basemap loading -->
  <link href="https://libs.cartocdn.com/mapbox-gl/v1.13.0/mapbox-gl.css" rel="stylesheet"/>
  <script src="https://libs.cartocdn.com/mapbox-gl/v1.13.0/mapbox-gl.js"></script>

  <!-- Document data manipulation-->
  <script src="https://d3js.org/d3.v4.min.js"></script>

  <!-- Chart plotting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.0.0/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>

  <!-- JQuery -->
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

  <!-- Add icon library -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">



</head>


<body>
    <div class="navContainer">
        <div class="logo-box">
          <a href="https://www.uzh.ch/en.html">
          <img src="https://www.geo.uzh.ch/microsite/giva/projects2021/Group9/Webpage/images/uzh_logo_e_pos.svg" height="68px" display="block"></img>
          </a>
        </div>
        <nav>
          <ul>
            <li className="introNav active"><a href="#introNav">Home</a></li>
            <li className="backgroundNav"><a href="#backgroundNav">background</a></li>
            <li className="mapNav"><a href="#mapNav">map</a></li>
            <li className="summaryNav"><a href="#summaryNav">summary</a></li>
            <li className="referencesNav"><a href="#referencesNav">references</a></li>
            <li className="authorsNav"><a href="#authorsNav">authors</a></li>
          </ul>
        </nav>
      </div>
      <div class="scrollableScreen" id="scrollableScreen">
        <div class="intro page" id="introNav">
          <div class="introWrapper">
            <img class="introImages"src="./images/mig_background.jpg" width="100%">
            <div class="e"><b>Remittance and Migration Flows</b></div> 
            <div class="e"> 
                <span class="s">Global Patterns</span>
            </div>
          </div>
        </div>
        <div class="background page" id="backgroundNav">
          <div class= "text-box"> 
            <div class="text-title">Background</div>
              <div class= "text-section">
                <p style="text-align: justify"> <b>Why remittances matter:</b><br>
                  The Sustainable Development Goals (SDG) are an urgent call
                  for action to reduce all forms of inequality and deprivation 
                  as well as to preserve the nature of our planet (UN, 2021). 
                  These goals are to be achieved by 2030. Migration is a cross-cutting 
                  issue and is relevant to all seventeen goals (Migration Data 
                  Portal, no date). While it is not explicitly one of the goals, 
                  it is crucial to understand migration patterns because of its 
                  relationship to the goals above. This Web Page provides an 
                  overview of migration and its aftereffect: Remittances.<br>
                  
                  <br>Remittances are household incomes from foreign countries 
                  that result from the temporary or permanent movement of people 
                  to those countries (IMF, 2009). In the past years the interest 
                  in remittances increased and bridges between academic and 
                  political spheres were created (Gubert, 2017). A specific United 
                  Nation goal is to decrease transaction costs (SDG 10.c) of migrant 
                  remittances, as this is one of the most important and mature steps 
                  taken to increase incomes in developing countries (IOM, 2017). 
                  Concrete examples in the Global Forum on Remittances, Investment 
                  and Development (GFRID, 2017) have shown how migrant remittances 
                  and diaspora investments were reducing poverty and hunger and 
                  promoting access to health and education (UN, no date).<br></p>
                  <b>7 facts about remittances:</b>
                  <br>
              </div>
              <img class="center-cropped" src="./images/Graphik_7Punkte_2.png" />
              <div class= "text-section">
                <p style="text-align: justify">In order to approach the reduction of inequalities – especially 
                  the remittance costs, it is crucial to better understand the global 
                  pattern and dynamics of migration and financial flows between countries. 
                  According to the Global Knowledge Partnership on Migration and Development 
                  (KNOMAD), which has the same objective, this knowledge can be used by 
                  policy makers in sending and receiving countries (Gubert, 2017).
                </p>
              </div>

              <iframe src="https://embed.ted.com/talks/lang/en/dilip_ratha_the_hidden_force_in_global_economics_sending_money_home"
                      height=40% 
                      width=60%
                      allowfullscreen=true>    
              </iframe>
          </div>
        </div>

        <div class="mapPage page" id="mapNav">
          <div class="mapSwitch">
            <div class="switch">
              <input type="radio" class="switch-input" name="view" value="migration" id="migration" checked>
              <label for="migration" class="switch-label switch-label-off">Migration</label>

              <input type="radio" class="switch-input" name="view" value="remittance" id="remittance">
              <label for="remittance" class="switch-label switch-label-on">Remittance</label>

              <span class="switch-selection"></span>
            </div>
          </div>
          <div class="migration selectt slide1">
            <div class="mapContainer">
                <div class="map" id="map"></div>
                <div class="arcslegend">
                  <div class="text-legend">
                    <p style="font-size:15px;display:inline;text-align:justify"><b>Migration from 2010 to 2015</b>
                    <p style="font-size:12px;text-align:justify">Estimated Migration [Number of people]</p>
                    <div class="legend-break">
                      <span style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(240,249,232);"></span>
                      <span> Legendeneintrag 1</span>
                    </div>
                    <div class="legend-break">
                      <span style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(186,228,188);"></span>
                      <span> Legendeneintrag 2</span>
                    </div>
                    <div class="legend-break">
                      <span style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(123,204,196);"></span>
                      <span> Legendeneintrag 3</span>
                    </div>
                    <div class="legend-break">
                      <span style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(67,162,202);"></span>
                      <span> Legendeneintrag 4</span>
                    </div>
                    <div class="legend-break">
                      <span style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgb(8,104,172);"></span>
                      <span> Legendeneintrag 5</span>
                    </div>
                  </div>
                </div>
            </div>
            <div class="optionBox">
              <fieldset class="layerSelection">
                <legend>Select a layer:</legend>
                <div>
                  <input type="radio" id="e" name="inout" value="e20_w0" onclick="layerChange(this.value)"
                        checked>
                  <label for="e">Emigration</label>
                </div>
                <div>
                  <input type="radio" id="i" name="inout" value="i20_w0" onclick="layerChange(this.value)">
                  <label for="i">Immigration</label>
                </div>
              </fieldset>
              <div class="chartWrapper chartSelector">
                <button type="button" class="expandChart btn"><i class="fa-solid fa-expand"></i></button>
                <canvas id="myChart" height="250"></canvas>
              </div>
            </div>
          </div>


          <div class="remittance selectt slide2">
            <div class="mapContainer">
              <div class="map" id="map_symbols"></div>
              <div class="symbolslegend">
                <div class="text-legend">
                  <p style="font-size:15px;display:inline;text-align:justify"><b>Worldwide Remittance Flows between 2017 and 2020</b>
                  <p style="font-size:12px;text-align:justify">Amount of Remittances received and sent [Mio US$]</p>
                  <div class="legend-break">
                    <span style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgba(148, 217, 212, 150);"></span>
                    <span> Remittance received</span>
                  </div>
                  <div class="legend-break">
                    <span style="display: inline-block; height: 15px; width: 15px; margin-right: 5px; background-color: rgba(233, 53, 80, 100);"></span>
                    <span> Remittances sent</span>
                  </div>
                </div>
            </div>

           
          </div>
           <!--FIO-->
           <div class="optionBox">
            <fieldset class="layerSelection">
              <legend>Select a year:</legend>
              <div>
                <input type="radio" id="r17" name="layername" value="r17" onclick="layerChangeR(this.value)"
                      checked>
                <label for="r17">2017</label>
              </div>
              <div>
                <input type="radio" id="r18" name="layername" value="r18" onclick="layerChangeR(this.value)">
                <label for="r18">2018</label>
              </div>
              <div>
                <input type="radio" id="r19" name="layername" value="r19" onclick="layerChangeR(this.value)">
                <label for="r19">2019</label>
              </div>
              <div>
                <input type="radio" id="r20" name="layername" value="r20" onclick="layerChangeR(this.value)">
                <label for="r20">2020</label>
              </div>
            </fieldset>
          </div>
        </div>      

        <script type="text/javascript">
            $(".remittance").hide();
            $(document).ready(function() {
                $('input[type="radio"]').click(function() {
                    var inputValue = $(this).attr("value");
                    var targetBox = $("." + inputValue);
                    if(inputValue === "migration" || inputValue ==="remittance"){  
                      showElement = $(targetBox);
                      $(".selectt").not(targetBox).hide();
                      showElement.show();
                    }
                });
            });

            $(document).ready(function() {
              $('.expandChart').click(function() {
                var chartWrapper = $('.chartSelector');
                if (chartWrapper.hasClass('chartWrapper')) {
                  $('.chartWrapper').removeClass("chartWrapper").addClass("chartBigWrapper");
                  createPlot(countryNumbers, 15);
                } else {
                  $('.chartBigWrapper').removeClass("chartBigWrapper").addClass("chartWrapper")
                  createPlot(countryNumbers, 5);
                }

              })
            })
        </script>

        <div class="summary page" id="summaryNav">
          <div class= "text-box"> 
            <div class="text-title">Summary</div>
              <div class= "text-section">
                <p> Hier kommt der Text hin </p>
              </div>
          </div>
        </div>

        <div class="references page" id="referencesNav">
          <div class= "text-box"> 
            <div class="text-title">References</div>
              <div class= "text-section">
                <p> International Monetary Fund (IMF) (2009) <i>International Transactions in Remittances: Guide for Compilers and Users.</i> doi: 10.1111/j.1468-2435.2009.00540.x.<br>
                  <br>Gubert, F. (2017) <i>Migration, Remittances and Development: Insights from the Migration and Development Conference, Revue d’Economie du Developpement,</i> 25(3–4), pp. 29–44. doi: 10.3917/edd.313.0029.<br>
                  <br>IOM (2017) <i>International dialogue on migration: Follow-up and review of migration in the sustainable development goals,</i> in.<br>
                  <br>Portal, M. D. (no date) <i>Migration data and the Sustainable Development Goals (SDGs).</i> Available at: https://www.migrationdataportal.org/sdgs?node=0.<br>
                  <br>UN (2019) <i>Remittances matter: 8 facts you don’t know about the money migrants send back home.</i> Available at: https://www.un.org/development/desa/en/news/population/remittances-matter.html.<br>
                  <br>UN (2021) <i>The Sustainable Development Goals Report 2021.</i><br>
                  <br>UN (no date) <i>Putting a spotlight on the role of migrant remittances in achieving the SDGs.</i> Available at: https://www.un.org/hi/desa/putting-spotlight-role-migrant-remittances-achieving-sdgs.
                   </p>
              </div>
          </div>
        </div>
        <div class="authors page" id="authorsNav">
          <div class="profile-card">
            <div class="img">
              <img src="./images/annina_stroke_2_cropped.png" ></img>
            </div>
            <div class="caption">
              <h3>Annina Ardüser</h3>
              <p>Master Student GIS</p>
            </div>
            <div class="social-links">
            </div>
          </div>
          <div class="profile-card">
          <div class="img">
              <img src="./images/team-2.jpg"></img>
          </div>
          <div class="caption">
            <h3>Fiona Federer</h3>
            <p>Master Student GIS</p>
            <div class="social-links">
            </div>
          </div>
          </div>
            <div class="profile-card">
              <div class="img">
                <img src="./images/annina_portrait.png"></img>
              </div>
              <div class="caption">
                <h3>Silvan Caduff</h3>
                <p>Master Student GIS</p>
              <div class="social-links">
              </div>
            </div>
          </div>
        </div>
      </div>
      <a href="#" class="to-top">
        <i class="fas fa-chevron-up"></i>
      </a>
</body>


<script language="JavaScript">  
    const pages = document.querySelectorAll('.page');
    const navLi = document.querySelectorAll('nav li');
    const scr = document.getElementById('scrollableScreen');
    
    scr.onscroll = () => {
    var current = "";
    pages.forEach((page) => {
        const pageTop = page.offsetTop;
        if(scr.scrollTop >= (pageTop - 400)) {
        current = page.getAttribute('id');
        }
    });
    
    navLi.forEach((li) => {
        li.classList.remove('active');
        
        if(li.classList.contains(current)){
        li.classList.add('active');
        }
    });
    };

    // Get components from the deckgl library
    const {DeckGL, GeoJsonLayer, ArcLayer, ScatterplotLayer, IconLayer} = deck;


    // Create deck instance symbols
    const deckgl_symbols = new DeckGL({
        mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
        container: 'map_symbols',
        initialViewState: {
          longitude: 6,
          latitude: 50,
          zoom: 3,
          maxZoom: 15,
          pitch: 30,
          bearing: 0
        },
        controller: true,
        layers: []
      });

    // colour scheme
    //teal: #d1eeea,#a8dbd9,#85c4c9,#68abb8,#4f90a6,#3b738f,#2a5674

    const POLYGON_COLORS = {
      COLOR_1: [255, 0, 0],
      COLOR_2: [255, 255, 0],
      COLOR_3: [0, 255, 255],
      COLOR_4: [255, 0, 255],
      COLOR_5: [0, 0, 255]
    };
  
    const ICON_MAPPING_OUT = {
      marker: {x: 1242, y: 0, width: 1242, height: 2479, anchorX: 0, anchorY: 1239.5, mask: true}
    }

    const ICON_MAPPING_IN = {
      marker: {x: 0, y: 0, width: 1242, height: 2479, anchorX: 1300, anchorY: 1239.5, mask: true}
    }

    var data_sorted = [];
    var iconLayer_in = '';
    var iconLayer_out = '';
    var in_out = 'r';
    var year_r = '17';

    layerChangeR("r17");

    function layerChangeR(name) {
      fetch('https://raw.githubusercontent.com/sicadu/geovis/main/reactless/data/'+name+'.json')
      .then(res => res.json())
      .then(d => updateLayersR(d));
    }
    
    function updateLayersR(data_r) {

      const iconLayer_out = new IconLayer({
          id:'icon_out',
          data: data_r,
          pickable: true,
          iconAtlas: './images/Remi_in_out.png',
          iconMapping: ICON_MAPPING_OUT,
          getIcon: d => 'marker',
          getPosition: d => [d.X, d.Y],
          getSize: d => (Math.sqrt(d.REMI_O))/2,
          //sizeScale: 10,
          //sizeMinPixels: 10,
          //sizeMaxPixels: 80,
          getColor: d => [233, 53, 80, 100] 
        });
        
        const iconLayer_in = new IconLayer({
          id: 'icon_in',
          data: data_r,
          pickable: true,
          iconAtlas: './images/Remi_in_out.png',
          iconMapping: ICON_MAPPING_IN,
          getIcon: d => 'marker',
          getPosition: d => [d.X, d.Y],
          getSize: d => (Math.sqrt(d.REMI_I))/2,
          //sizeScale: 0,
          //sizeMinPixels: 10,
          //sizeMaxPixels: 80,
          getColor: d => [148, 217, 212, 150],
          pickable: true
        });

        // evtl remittance costs hinzunehmen / remittance cost charts
        deckgl_symbols.setProps({
          layers: [iconLayer_in, iconLayer_out],
          getTooltip: ({object}) => object && {
            html: `
            <p><b> Country: </b>${object.COUNTRY}</p>
            <p><b> Incoming Remittances (IR): </b>${object.REMI_I} Mio. | ${Math.round(object.REMI_I*100000000/object.GDP)}% of GDP</p>
            <p><b> Outgoing Remittances (OR): </b>${object.REMI_O} Mio. | ${Math.round(object.REMI_O*100000000/object.GDP)}% of GDP</p>
            `,
            style: {
              color: '#000000',
              fontSize: '0.2em',
              backgroundColor: '#f5f5f5',
              opacity: 0.85
            }
          }});
    }

    // create choropleth map  
    const choroplethMap = new GeoJsonLayer({
      data: './data/netMig_2010_2015_2020.json',
      pickable: true,
      stroked: true,
      filled: true,
      wireframe: true,
      getPolygon: d => d.features.geometry.coordinates,
      getLineColor: [255, 80, 80],
      getLineWidth: 1,
      lineWidthMinPixels: 1,
      getFillColor: a => {
        if (a.features.properties.F2010_2015 < -20.0) {
          return POLYGON_COLORS.COLOR_1;
        } else if (a.features.properties.F2010_2015 < -7.0) {
          return POLYGON_COLORS.COLOR_2;
        } else if (a.features.properties.F2010_2015 < 3.0) {
          return POLYGON_COLORS.COLOR_3;
        } else if (a.features.properties.F2010_2015 < 18.0) {
          return POLYGON_COLORS.COLOR_4;
        } else if (a.features.properties.F2010_2015 < 55.0) {
          return POLYGON_COLORS.COLOR_5;
        };
      },
    });



    // Create deck instance arcs
    const deckgl = new DeckGL({
        mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
        container: 'map',
        initialViewState: {
          longitude: 6,
          latitude: 50,
          zoom: 3,
          maxZoom: 15,
          pitch: 30,
          bearing: 0
        },
        controller: true,
        layers: []
      });



    
    // Define Arc colors -- Color with colorBrewer sequential 5 Colors 
    const inFlowColors = [ 
      [240,249,232],
      [186,228,188],
      [123,204,196],
      [67,162,202],
      [8,104,172],
    ];

    const outFlowColors = [
      [240,249,232],
      [186,228,188],
      [123,204,196],
      [67,162,202],
      [8,104,172],
    ];

    

    var dataSorted = [];
    var countyLayer = '' ;
    var arcLayer = '';
    var countryNumbers;
    var inout = 'e';
    var year = '10';
    var startCountry = 'GERMANY';

    layerChange("e20_w0");

    function layerChange(layerName) {
      fetch('https://raw.githubusercontent.com/sicadu/geovis/main/reactless/data/'+layerName+'.json')
      .then(res => res.json())
      .then(data => {
        dataSorted = keysrt(data.features, ['properties','COUNTRY']);

        countyLayer = new GeoJsonLayer({
          id: 'geojson',
          data,
          stroked: false,
          filled: true,
          autoHighlight: true,
          getFillColor: () => [0, 0, 0, 0],
          onClick: info => updateLayers(info.object),
          pickable: true
        });

        updateLayers(
          dataSorted.find(f => f.properties.COUNTRY === startCountry)
        );
      });
    }

    function updateLayers(dataFeature) {
        selectedFeature = dataSorted.find(f => f.properties.COUNTRY === dataFeature.properties.COUNTRY);
        startCountry = dataFeature.properties.COUNTRY;

        const flows = selectedFeature.properties.flows;
        const centroid = selectedFeature.geometry.centroid;


        const arcs = Object.keys(flows).map(toId => {
          const f = dataSorted[toId];
          return {
            source: centroid,
            target: f.geometry.centroid,
            value: flows[toId]
          };
        });

        countryNumbers = Object.keys(flows).map(toId => {
          const r = dataSorted[toId];
          return {
            country: r.properties.COUNTRY,
            migration: flows[toId]
          };
        });

        createPlot(countryNumbers, 5);

        const scale = d3.scaleQuantile()
          .domain(arcs.map(a => Math.abs(a.value)))
          .range(inFlowColors.map((c, i) => i));

        arcs.forEach(a => {
          a.gain = Math.sign(a.value);
          a.quantile = scale(Math.abs(a.value));
        });

        arcLayer = new ArcLayer({
          id: 'arc',
          data: arcs,
          getSourcePosition: d => d.source,
          getTargetPosition: d => d.target,
          getSourceColor: d => (d.gain > 0 ? inFlowColors : outFlowColors)[d.quantile],
          getTargetColor: d => (d.gain > 0 ? inFlowColors : outFlowColors)[d.quantile],
          widthMinPixels: 1, /* Breite von Linien*/
          greatCircle: true,
          getHeight: 0.1
        });

        deckgl.setProps({
          layers: [countyLayer, arcLayer, choroplethMap]
        });
    }

    function keysrt(arr, keyArr, reverse) {
          var sortOrder = 1;
          if(reverse)sortOrder = -1;
          return arr.sort(function(a, b) {
              var x=a,y=b;
              for (var i=0; i < keyArr.length; i++) {
                x = x[keyArr[i]];
                y = y[keyArr[i]];
              }
              return sortOrder * ((x < y) ? -1 : ((x > y) ? 1 : 0));
          });
      }

    var myChart;


    function createPlot(data, n){
      if (myChart){
        myChart.destroy();
      }

      var topCountries = getTopN(data, 'migration', n);
      var migrationValues = [];
      var countryKey = [];

      for (let i =0; i<n ;i++) {
        migrationValues.push(topCountries[i]['migration']);
        countryKey.push(topCountries[i]['country']);
      } 

      Chart.register(ChartDataLabels)

      const config = {
        type: 'bar',
        data: {
          labels: countryKey,
          datasets: [
            {
              backgroundColor: ["#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"],
              data: migrationValues,
              datalabels: {
                color: 'white',
                anchor: 'end',
                align: 'start',

              }
            }
          ]
        },
        options: {
          maintainAspectRatio: false,
          indexAxis: 'y',
          plugins: {
            title: {display: true, 
              text: 'Top Migration',
              font: {
                size: 15,
              }},
            legend: {display: false},
            tooltips: {enabled: false}
          },
          scales: {
            y: {
              beginAtZero: true
            }
          }
        },
        plugins: [ChartDataLabels]
      };

      myChart = new Chart(
        document.getElementById('myChart'),
        config
      );
    }

    function getTopN(arr, prop, n) {
      // clone before sorting, to preserve the original array
      var clone = arr.slice(0); 

      // sort descending
      clone.sort(function(x, y) {
          if (x[prop] == y[prop]) return 0;
          else if (parseInt(x[prop]) < parseInt(y[prop])) return 1;
          else return -1;
      });

      return clone.slice(0, n || 1);
    }

    const toTop = document.querySelector('.to-top');
  
    window.addEventListener("scroll", () => {
      if (window.pageYOffset > 100) {
        toTop.classList.add("active");
      } else {
        toTop.classList.remove("active");
      }
    })
  
</script>